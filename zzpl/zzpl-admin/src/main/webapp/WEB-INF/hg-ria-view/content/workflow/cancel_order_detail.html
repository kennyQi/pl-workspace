<#assign contextPath=springMacroRequestContext.getContextPath() />
<div class="row">
	<div class="col-md-12">
		<div class="tab-content">
			<div class="tab-pane active">
				<div class="portlet box yellow">
					<div class="portlet-title">
						<div class="caption">
							&nbsp;退票订单详情
						</div>
					</div>
					<div class="portlet-body form">
							<input type="hidden" value="${taskListWaitDto.id}" name="tasklistWaitID"/>
							<#list taskListWaitDto.workflowInstanceOrderDTOs as order>
							<form method="post" action="${contextPath}/tasklistwait/${taskListWaitDto.actionValue}"
							class="form-horizontal pageForm required-validate"  style="margin-left: 60px;" id="myForm"
							onsubmit="return validateCallback(this, hgTabAjaxDone)">
							<input type="hidden" hidden="hidden" name="tasklistWaitID" value="${taskListWaitDto.id}">
							<hr>
							<h3 style="background-color: #CCE7F5;color:#0a5c88;font-size: 18px;"><strong>出差人员基本信息</strong></h3>
							<hr>
							<div style="font-size: 16px;">
								<table  class="table table-striped table-bordered table-hover">
									<tr>
										<th>姓名</th>
										<th>证件号</th>
										<th>手机号</th>
										<th>退票种类</th>
										<!-- <th>退票理由</th> -->
										<th>机票类型</th>
										<th>成本中心</th>
									</tr>
									<tr>
										<#list order.passengers as passenger>
											<td>${passenger.passengerName}</td>
											<td>${passenger.idNO}</td>
											<td>${passenger.telephone}</td>
											<td><#if passenger.refundType=="1">当日作废
												<#elseif passenger.refundType =="2">自愿退票
												<#elseif passenger.refundType =="3">非自愿退票
												<#elseif passenger.refundType =="4">差错退款
												<#elseif passenger.refundType =="5">其他
												</#if>
											</td>
											<!-- <td>${passenger.refundMemo}</td> -->
											<td><#if passenger.orderType==2>国际机票<#else>国内机票</#if></td>
											<td>${order.costCenterName} </td>
										</#list>
									</tr>
								</table> 
							</div>
							<hr>
							<h3 style="background-color: #CCE7F5;color:#0a5c88;font-size: 18px;"><strong>计划机票基本信息</strong></h3>
							<hr>
							<div  style="font-size: 16px;">
								<table  class="table table-striped table-bordered table-hover">
									<tr>
										<th>航班信息</th>
										<th>起降时间</th>
										<th>起降机场</th>
										<th>舱位信息</th>
										<th>票价</th>
										<th>机建燃油</th>
										<th>实际支付价</th>
										<#if role == "success">
											<th>出票渠道</th>
										</#if>
										<th>支付类型</th>
										<th>支付状态</th>
									</tr>
									<tr>
										<td>航空公司:${order.airCompanyName}
											<br/>航班:${order.flightNO}
											<br/>机型:${order.planeType}</td>
										<td>${order.startTime}<br/>${order.endTime}</td>
										<td>${order.departAirport}<br/>${order.arrivalAirport}</td>
										<td>${order.cabinName}${order.cabinCode}</td>
										<td>￥${order.ibePrice}</td>
										<td>￥${order.buildFee+order.oilFee}</td>
										<td>￥${order.platTotalPrice}</td>
										<#if role == "success">
											<td>${order.ticketChannelName}</td>
										</#if>
										<td>${order.payTypeMSG}</td>
										<td>${order.payStatusMSG}</td>
									</tr>
								</table> 
							</div>
							<hr>
							<h3 style="background-color: #CCE7F5;color:#0a5c88;font-size: 18px;"><strong>出差说明</strong></h3>
							<hr>
							<div style="font-size: 16px;">
								<table  class="table table-striped table-bordered table-hover">
									<tr>
										<th>出差说明</th>
									</tr>
									<tr>
										<td>${order.note}</td>
									</tr>
								</table> 
							
							</div>
							<hr>
							<h3 style="background-color: #CCE7F5;color:#0a5c88;font-size: 18px;"><strong>审批信息</strong></h3>
							<hr>
							<div  style="font-size: 16px;">
								<table  class="table table-striped table-bordered table-hover">
										<tr>
											<th>审批人</th>
											<th>审批意见</th>
											<th>操作</th>
										</tr>
										<#list taskListWaitDto.previousUserName as name>
										<tr>
											<td>${name}</td>
											<td>通过</td>
											<td></td>
										</tr>
										</#list>
										<tr>
											<td>${user.name}</td>
											<td>通过</td>
											<td>下一个环节：
												<select name="nextStepNO" id="stepNO" onchange="onchangeText();">
													<option selected="selected" value="0">请选择</option>
												<#list taskListWaitDto.stepDTOs as step>
													<option value="${step.stepNO}">${step.stepName}</option>
												</#list>
												</select>
												<label style="color: red;">*必选</label>
												人选：
												<select id="executor" name="nextUserIDs">
												<option selected="selected">请选择</option>
												</select>
												<label style="color: red;">*必选</label>
											</td>
										</tr>
								</table> 
							</div>
							<div class="form-actions">
								<span id="buttonspan">
									<#if order.printTicketType==1>
									<!-- 出票类型为自动出票、退票部门经理和差旅用这种方式提交 -->
										<input class="btn yellow"  type="button" value="${taskListWaitDto.buttonName}" onclick="check('${taskListWaitDto.actionValue}');" />
										
									<#elseif order.printTicketType==2>
										<#if taskListWaitDto.actionValue=="managerCancel">
										<!-- 出票类型为手动出票、退票部门经理用这种方式提交 -->
											<input class="btn yellow"  type="button" value="${taskListWaitDto.buttonName}" onclick="tijiao();" />
										<#else>
										<!-- 出票类型为手动出票、差旅用这种方式提交 -->
										<a class="btn yellow"  href="${contextPath}/view/manaul/${taskListWaitDto.actionValue}?tasklistWaitID=${taskListWaitDto.id}" 
										target="hgTab" >${taskListWaitDto.buttonName}</a> 
										</#if>
									</#if>
										<#list taskListWaitDto.actionDTOs as action>
											<#if action.actionValue=="taskProcessVoid">
												<input class="btn yellow" style="float:right;margin-right: 10px;"  type="button" value="${action.buttonName}" onclick="check1('${action.actionValue}');" />&nbsp;&nbsp;&nbsp;
											</#if>
										</#list>
										<a class="btn yellow" target="cancel">取消</a>
								</span>
							</div>
						</form>
						</#list>
					</div>
				</div>
			</div>
		</div>
	</div>
</div>
<script>
//方法添加时间 2015年8月12日 12:41:59
//guok
function onchangeText(){
	var stepNO = $("#stepNO").val();
	if(stepNO=="0"){
		document.all['executor'].options.length = 0; //清空原有的option 
		var str="<option>请选择</option>"; 
		$("#executor").html(str); 
	}else{
		$.ajax({ 
			url : "${contextPath}/view/chooseExecutor?workflowInstanceID=${taskListWaitDto.workflowInstanceID}&workflowID=${taskListWaitDto.workflowID}", 
			data : {nextStepNO : stepNO}, // 参数 
			type : "post", 
			cache : false, 
			dataType : "json", //返回json数据 
			error: function(){ 
			alert('error'); 
			}, 
			success:onchangecallback 
		});
	}
	 
}
function onchangecallback(data){ 
	document.all['executor'].options.length = 0; //清空原有的option 
	var str=""; 
	for(var i=0;i<data.length;i++){ 
		str+="<option value='"+data[i].userID+"'>"+data[i].name+"</option>" 
	} 
	$("#executor").html(str); 
}

function check(actionval){
	var stepNO = $("#stepNO").val();
	if(stepNO=="0"){
		alert("请选择环节");
		return;
	}
	var executor = $("#executor").val();
	if(executor=="0"){
		alert("请选择处理人");
		return;
	}
	$("#buttonspan").html("处理中...");
	$("#myForm").attr("action","${contextPath}/tasklistwait/"+actionval);
	$("#myForm").submit();
}

function check1(actionval){
	$("#buttonspan").html("处理中...");
	$("#myForm").attr("action","${contextPath}/tasklistwait/"+actionval);
	$("#myForm").submit();
}
function tijiao(){
	var stepNO = $("#stepNO").val();
	if(stepNO=="0"){
		alert("请选择环节");
		return;
	}
	var executor = $("#executor").val();
	if(executor=="0"){
		alert("请选择处理人");
		return;
	}
	$("#buttonspan").html("处理中...");
	$("#myForm").attr("action","${contextPath}/view/manaul/${taskListWaitDto.actionValue}?tasklistWaitID=${taskListWaitDto.id}");
	$("#myForm").submit();
}

</script>