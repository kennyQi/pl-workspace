<#assign contextPath=springMacroRequestContext.getContextPath() />
<div class="row">
	<div class="col-md-12">
		<div class="portlet light bordered">
			<div class="portlet-title">
				<div class="caption">
					<span class="caption-subject font-red-sunglo bold uppercase">流程列表</span>
				</div>
				<div class="actions">
					
				</div>
			</div>
			<div class="portlet-body">
				<div class="row">
					<div class="col-md-4">
						<label>
							流程名称：${workflow.workflowName}
						</label>
					</div>
				</div>
				<form method="post" action="${contextPath}/workflow/workflowStepEdit"  id="myform" target="selectedTodo" onsubmit="return validateCallback(this, hgTabAjaxDone)" >  
					<table class="table table-striped table-bordered table-hover" name='tbl' id="tab" >
						<tr>
							<!-- <th>环节编号</th> -->
							<th>环节名称</th>
							<th>处理人</th>
							<th>表单按钮</th>
							<th>下一步</th>
							<th class="text-center">操作</th>
						</tr>
						<tr class="odd gradeX">
							<input name="workflowStepID" value="${workflowStep.id}" readonly="readonly" id="workflowID" type="hidden" class="workflowID">
							<input value="${workflowStep.stepNO}" readonly="readonly" id="workflowStepNO" type="hidden" class="workflowID">
							<td>
								<input type="text" value="${workflowStep.stepName}" name="stepName" class="required stepName" />
							</td>
							<td>
								<select id="chooseExecutorType" name="chooseExecutorType" onchange="getExecutor()">
									<option value="0">--请选择--</option>
									<option value="2" <#if workflowStep.chooseExecutorType=="2">selected="selected"</#if>>角色</option>
									<option value="4" <#if workflowStep.chooseExecutorType=="4">selected="selected"</#if>>自定义</option>
								</select>
								<select id="executor" name="executor" onchange="changeExecutor()">
									<option value="0">--请选择--</option>
									<#list executors as executor>
										<#if workflowStep.chooseExecutorType=="2">
											<#assign flag="0"/>
											<#if executor.id==workflowStep.executor>
												<option value="${executor.id}" selected="selected">${executor.roleName}</option>
												<#assign flag="1"/>
											</#if>
											<#if flag=="0">
												<option value="${executor.id}">${executor.roleName}</option>
											</#if>
										</#if>
									</#list>
									<#if workflowStep.chooseExecutorType=="4">
											<#if "-1"==workflowStep.executor>
												<option value="-99" >起草人</option>
												<option value="-1" selected="selected">上一环节处理人</option>
											<#elseif "-99"==workflowStep.executor>
												<option value="-99"  selected="selected">起草人</option>
												<option value="-1" >上一环节处理人</option>
											</#if>
										</#if>
								</select>
							</td>
							<td>
								<#list stepActions as action>
									<#assign flag="0"/>
									<#if (workflowStep.workflowStepActions)??>
										<#list workflowStep.workflowStepActions as stepAction>
											<#if stepAction.stepAction.id==action.id>
												<input type="checkbox" checked="checked" name="actionID" value="${action.id}" 
												<#if workflowStep.executor=="CLGLY">
													<#if action.id=="3"||action.id=="7"||action.id=="13"||action.id=="16"||action.id=="17">
													<#else>
														disabled="disabled"
													</#if>
												<#else>
													<#if action.id=="3"||action.id=="7"||action.id=="13"||action.id=="16"||action.id=="17">
														disabled="disabled"
													</#if>
												</#if> 
												>${action.actionName}&nbsp;
												<#assign flag="1"/>
											</#if>
										</#list>
									</#if>
									<#if flag=="0">
										<input type="checkbox" name="actionID" value="${action.id}" class="actionID" 
										<#if workflowStep.executor=="CLGLY">
											<#if action.id=="3"||action.id=="7"||action.id=="13"||action.id=="16"||action.id=="17">
											<#else>
												disabled="disabled"
											</#if>
										<#else>
											<#if action.id=="3"||action.id=="7"||action.id=="13"||action.id=="16"||action.id=="17">
												disabled="disabled"
											</#if>
										</#if> 
										>${action.actionName}&nbsp;
									</#if>
								</#list>
							</td>
							<td>
								<#list workflowSteps as allworkflowStep>
									<#assign flag="0"/>
									<#if (workflowStep.nextStepNO)??>
										<#list workflowStep.nextStepNO?split(";") as stepNO>
											<#if allworkflowStep.stepNO==stepNO>
												<input type="checkbox" checked="checked" name="nextStepNO" value="${allworkflowStep.stepNO};" class="actionID">${allworkflowStep.stepName}&nbsp;
												<#assign flag="1"/>
											</#if>
										</#list>
									</#if>
									<#if flag=="0">
										<input type="checkbox" name="nextStepNO" value="${allworkflowStep.stepNO};" class="actionID">${allworkflowStep.stepName}&nbsp;
									</#if>
								</#list>
								<#assign endflag="0"/>
								<#if (workflowStep.nextStepNO)??>
									<#list workflowStep.nextStepNO?split(";") as stepNO>
										<#if "99"==stepNO>
											<input type="checkbox" checked="checked" name="nextStepNO" value="99;" class="actionID">结束流程&nbsp;
											<#assign endflag="1"/>
										</#if>
									</#list>
									<#if endflag=="0">
										<input type="checkbox" name="nextStepNO" value="99;" class="actionID">结束流程&nbsp;
									</#if>
								<#else>
									<input type="checkbox" name="nextStepNO" value="99;" class="actionID">结束流程&nbsp;
								</#if>
							</td>
							<td class="text-center">
								<span id="buttonspan">
									<button class="btn btn-sm yellow filter-submit margin-bottom" onclick="return saveStep();"> 保存 </button>
									</span>
							</td>
						</tr>
					</table>
				</form>
			</div>
		</div>
	</div>
</div>

<script>

//select框联动
function getExecutor(){
	//选择‘请选择’
	if($("#chooseExecutorType").val()=="0"){
		var html_str = "<option value='nothing'>--请选择--</option>";
		$("#executor").html(html_str);
	}else {
		//选择其他值 发送ajax请求
		$.ajax({     
	        url: "${contextPath}/workflow/chooseExecutor?chooseExecutorType="+$("#chooseExecutorType").val(),
	        type: "POST",
	        dataType: "json",
	        success: function(data, textStatus){
				var html_str = "<option value='0'>--请选择--</option>";
	        	if($("#chooseExecutorType").val()=="2"){
		            var users = JSON.parse(data);
					for(var i = 0;i<users.length;i++){
						html_str+="<option value='"+users[i].id+"'>"+users[i].roleName+"</option>";
					}
	        	}else if($("#chooseExecutorType").val()=="4"){
	        		var users = JSON.parse(data);
	        		for(var i = 0;i<users.length;i++){
	        			html_str+="<option value='"+users[i].userFlagkey+"'>"+users[i].userFlagval+"</option>";
					}
	        	}
				$("#executor").html(html_str);
	        }
	    });
	}
}
function changeExecutor(){
	console.log($("#executor").val());
	if($("#executor").val()!="CLGLY"){
		console.log(1);
		for(var i =1 ;i<18;i++){
			if(i==3||i==7||i==13||i==16||i==17){
				$(":checkbox[value='"+i+"']").attr('disabled','disabled');
				$(":checkbox[value='"+i+"']").attr("checked",false);
			}else{
				$(":checkbox[value='"+i+"']").attr("disabled",false);
				$(":checkbox[value='"+i+"']").attr("checked",false);
			}
		}
	}else{
		for(var i =1 ;i<18;i++){
			if(i==3||i==7||i==13||i==16||i==17){
				$(":checkbox[value='"+i+"']").attr("disabled",false);
				$(":checkbox[value='"+i+"']").attr("checked", true);
			}else{
				$(":checkbox[value='"+i+"']").attr('disabled','disabled');
				$(":checkbox[value='"+i+"']").attr("checked",false);
			}
		}
	}
}
function saveStep(){
	var str = "";
	$("input[name='actionID']:checked").each(function(){
		str+=$(this).val()+";";
	});
	if($.trim($("input[name='stepName']").val()).length==0){
		alert("请填写环节名称");
		return false;
	}
	if(($("#chooseExecutorType").val()=="0")&&($("#workflowStepNO").val()!=1)){
		alert("请选择执行人类型");
		return false;
	}else if($("#workflowStepNO").val()==1){
		$("#chooseExecutorType").val(0);
	}
	if(($("#executor").val()=="0")&&($("#workflowStepNO").val()!=1)){
		alert("请选择执行人");
		return false;
	}else if($("#workflowStepNO").val()==1){
		$("#chooseExecutorType").val(0);
	}
	if($("#executor").val()=="CLGLY"){
		if($(":checkbox[value='7']").is(':checked') ==true){
			if($(":checkbox[value='3']").is(':checked') ==true||$(":checkbox[value='13']").is(':checked') ==true||$(":checkbox[value='16']").is(':checked') ==true){
				alert("出票操作与退票操作不能同时被选中");
				return false;
			}
		}
	}else if($(":checkbox[value='10']").is(':checked') ==true||$(":checkbox[value='12']").is(':checked') ==true){
		if($(":checkbox[value='11']").is(':checked') ==true||$(":checkbox[value='14']").is(':checked') ==true){
			alert("出票操作与退票操作不能同时被选中");
			return false;
		}
	}
	 /*  $.ajax({
        type: "POST",
        dataType: "html",
        data:$("#myform").serialize(),
        url: "${contextPath}/workflow/workflowStepAdd",
        success: function(data, textStatus){
			var html_str = "<option value='nothing'>--请选择--</option>";
        	
			$("#executor").html(html_str);
        }
     });  */
}
</script>
