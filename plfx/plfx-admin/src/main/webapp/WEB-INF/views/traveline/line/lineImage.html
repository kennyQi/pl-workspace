<#assign contextPath=springMacroRequestContext.getContextPath() />
<#assign navTabid = navTabid!'lineImage' />
<#assign pathUrl =(contextPath+'/lineImage') />

<style>
.myTabsButton {
	position: relative;
	float: right;
	margin-right: -4px;
	margin-top: -28px;
}
.myTabsButton button {
	width: 70px;
}
.myPageContent {
	margin-top: -28px;
}
.myPageLabel {
	font-weight: 700;
}
.myUnit {
	margin: 7px 8px;
	border: 1px solid #b8d0d6;
	display: inline-block
}
.myLabel {
	padding-left: 4px;
}
.myInput{
	width:13px;margin:7px 1px 10px 15px;vertical-align:middle;
}
.pages span {
	margin-left: 15px;
}
</style>
<script type="text/javascript" src="resources/js/MyJs.js"></script>
<script type="text/javascript" src="${contextPath}/resources/js/kindeditor/kindeditor-min.js"></script>
<script type="text/javascript" src="${contextPath}/resources/js/kindeditor/lang/zh_CN.js"></script>
<script type="text/javascript">
validateCallbackLine = function(evt){
	if(fromHand())
		return validateCallback(evt,dialogAjaxDone);
	else
		return false;
}
</script>

<div id="linePicDialog">
<div class="tabs">
	<!-- 选项栏 -->
	<div class="tabsHeader">
		<div class="tabsHeaderContent">
			<ul>
			<li class="selected" onclick="getTabsIndex(this);"> 
				<a href="#">
					<span>首图</span>
				</a>
			</li>
			<#if (routeCounts > 0)>
				<#list 1..routeCounts as routeDay>
					<!-- <li ${(image_index == 0)?string('class="selected"','')} onclick="getTabsIndex(this);"> -->
					<li onclick="getTabsIndex(this);">
						<a href="#">
							<span>行程${routeDay_index+1}</span>
						</a>
					</li>
				</#list>
			</#if>
			</ul>
			<!-- <div class="button myTabsButton myFloat">
				<div class="buttonContent">
					<button style = "width:100px;" type="button" onclick="newFolder();">新建文件夹</button>
				</div>
			</div> -->
		</div>
	</div>
	
	<!-- 选线卡内容 -->
	<div class="tabsContent" style="height:298px;">
		<!-- 首图开始 -->
		<div class="myTabsBody">
			<div class="pageContent" style="width:760px;">
				<div class="panelBar">
					<ul class="toolBar">
						<li>
							<a class="delete" href="#" onclick="delImage();">
								<span>批量删除</span>
							</a>
						</li>
					</ul>
				</div>
				<div class="imgContext" layoutH="245">
					<#if line.lineImageList??>
					<#list line.lineImageList as headImage>
					<div class="unit myUnit">
						<img class="img-polaroid" width="160" height="120" alt="${headImage.name}" title="${headImage.name}"
							src="${image_host}${(headImage.urlMaps['default'])!''}" imageId="${headImage.imageId}"
							lindId="${headImage.lindId}" dayrouteId="head"/>
						<p style="height:25px;line-height:20px;">
							<input class="checkboxCtrl" type="checkbox" name="pictureIds" class="myInput" value="${headImage.imageId}" />
							<label class="myLabel">${headImage.name}</label>
						</p>
					</div>
					</#list>
					</#if>
				</div>
				<div class="panelBar hover">
					<div class="pages" style="float:right;">
						<span>
							<button type="button" class="checkboxCtrl" group="pictureIds">全选</button>
						</span>
						<span>
							<button type="button" class="checkboxCtrl" group="pictureIds" selectType="invert">反选</button>
						</span>
					</div>
				</div>
			</div>
		</div>
		<!-- 首图结束-->
		<!-- 行程图片开始 -->
		<#if (routeCounts > 0)>
		<#list 1..routeCounts as routeDay>
		<div class="myTabsBody">
			<div class="pageContent" style="width:760px;">
				<div class="panelBar">
					<ul class="toolBar">
						<li>
							<a class="delete" href="#" onclick="delImage();">
								<span>批量删除</span>
							</a>
						</li>
					</ul>
				</div>
				<div class="imgContext" layoutH="245">
				<#if line.routeInfo.dayRouteList??>
				<#list line.routeInfo.dayRouteList as dayRoute>
					<!-- 对应的第几天行程 -->
					<#if routeDay_index+1 == dayRoute.days>
					<#if dayRoute.lineImageList??>
					<#list dayRoute.lineImageList as image>
					<div class="unit myUnit">
						<img class="img-polaroid" width="160" height="120" alt="${image.name}" title="${image.name}"
							src="${image_host}${(image.urlMaps['default'])!''}" imageId="${image.imageId}" dayrouteId="${dayRoute.id}"/>
						<p style="height:25px;line-height:20px;">
							<input class="checkboxCtrl" type="checkbox" name="pictureIds" class="myInput" value="${image.imageId}" />
							<label class="myLabel">${image.name}</label>
						</p>
					</div>
					</#list>
					</#if>
					</#if>
				</#list>
				</#if>
				</div>
				<div class="panelBar hover">
					<div class="pages" style="float:right;">
						<span>
							<button type="button" class="checkboxCtrl" group="pictureIds">全选</button>
						</span>
						<span>
							<button type="button" class="checkboxCtrl" group="pictureIds" selectType="invert">反选</button>
						</span>
					</div>
				</div>
			</div>
		</div>
		</#list>
		</#if>
		<!-- 行程图片结束 -->
	</div>

	<!-- 选线卡底部 -->
	<div class="tabsFooter">
		<div class="tabsFooterContent"></div>
	</div>
</div>

<div class="pageContent myPageContent">
	<form method="post" action="${contextPath}/lineImage/modifyLineImage" enctype="multipart/form-data" class="pageForm required-validate"
		onsubmit="return validateCallbackLine(this);">
		<input type="hidden" name="navTabid" value="${navTabid!}" />
		<!-- 提交的图片信息 -->
		<input type="hidden" name="fdfsFileInfoJSON" id="fdfsFileInfoJSON" value=""/>
		<input type="hidden" id="lineId" name="lineId" value="${line.id!}" />
		<input type="hidden" name="dayRouteId" id="dayRouteId" value=""/>
		<!-- 行程信息 -->
		<input type="hidden" name="fdfsFileInfoJSONList" id="0" value=""
			lindId="${line.id}" dayrouteId=""/>
		<#list line.routeInfo.dayRouteList as dayRoute>
			<input type="hidden" name="fdfsFileInfoJSONList" id="${dayRoute_index+1}" value=""
				lindId="" dayRouteId="${dayRoute.id}"/>
		</#list>
		<div class="pageFormContent" style="background:#EAF1FD;">
			<label class="myPageLabel">上传图片</label>
			<div class="unit">
				<span class="u-upload">
					<!-- <img alt="" id="articleTitleImage" width="100" height="100"> -->
					<input type="file" name="fileName" id="add_article_file_upload"/>
					<!-- <input id="file123" type="file" name="file" size="60" onchange="imgUpload(this);"/> -->
					<!-- <input id="uploadFlag" type="hidden" class="required" value=""/>  是否上传图片标识 -->
				</span>
				<span style="color:gray;">请上传JPG/PNG/GIF/BMP格式的图片，最大不超过2M</span>
				<span id="hiddContent"></span>
			</div>
		</div>
		<div class="formBar">
			<ul>
				<li>
					<div class="buttonActive">
						<div class="buttonContent">
							<button type="submit" style="width:35px;" onclick="">确定</button>
						</div>
					</div>
				</li>
				<li>
					<div class="button">
						<div class="buttonContent">
							<button type="button" onclick="MyClose('是否取消维护图片？','monitorDiag')" style="width:35px;">取消</button>
						</div>
					</div>
				</li>
			</ul>
		</div>
	</form>
</div>
</div>

<script type="text/javascript">
	var imgIndex = 0;//新增图片下标
	var tabsIndex = 0;							//选项卡索引
	//var uploadPath = '${pathUrl}/imgUpload';	//图片上传地址
	//var groupURL = '/group0/';
	var headHtml = '<li class="selected" onclick="getTabsIndex(this);"><a href="#"><span>$name</span></a></li>';
	var imgHtml = '<div class="unit myUnit"><img class="img-polaroid" width="160" height="120" alt="$name" title="$name" src="$uri"/>'+
		'<p style="height:25px;line-height:20px;"><input class="checkboxCtrl" type="checkbox" name="pictureIds" class="myInput" value="0"/>'+
		'<label class="myLabel">$name</label></p><div class="imgIdContext"><input name="names" type="hidden" value="$name"/><input name="'+
		'imgNames" type="hidden" value="$imgName"/><input name="imgFlags" type="hidden" value="$imgFlag"/></div></div>';
	var divHtml = '<div class="myTabsBody"><div class="pageContent" style="width:760px;"><div class="panelBar"><ul class="toolBar"><li>'+
		'<a class="delete" href="#" onclick="delImage();"><span>批量删除</span></a></li></ul></div><div class="imgContext" layoutH="245">'+
		'<input name="folderId" type="hidden" value="$folderId"/></div><div class="panelBar hover"><div class="pages" style="float:right;"'+
		'><span><button type="button" class="checkboxCtrl" group="pictureIds">全选</button></span><span><button type="button" class="'+
		'checkboxCtrl" group="pictureIds" selectType="invert">反选</button></span></div></div></div></div>';

	$(function() {
		//渲染编辑器
		initKindEditor();
		$("#add_article_file_upload").uploadify({
	         'method'   : 'post',  
	         'buttonText' : '请选择',  
	         'swf'         : '${contextPath}/resources/dwz-ria/uploadify/scripts/uploadify.swf',
	 		 'uploader'      : '${contextPath}/image/upload',
	         'fileObjName'   : 'imgFile', 
	         'onUploadSuccess' : function(file, data, response) {
	        	var img=$.parseJSON(data);
	            var imgContext = getImgContext();
		        if(undefined != imgContext){
		        		imgContext.append(
		        			imgHtml.replace(/\$name/g,img.fileName)
		        				.replace(/\$imgName/g, "")
		        				.replace(/\$imgFlag/g,"+")
		        				.replace(/\$uri/g,img.url)
		        			);
		        }
		        var fdfsFileInfoJSON = $("#"+tabsIndex+"").val();
		        var infoStr = JSON.stringify(img.fdfsFileInfo);
		        if(fdfsFileInfoJSON == ""){
		        	fdfsFileInfoJSON = infoStr;
		        }else{
		        	fdfsFileInfoJSON = fdfsFileInfoJSON + "&365" + infoStr;
		        }
		        $("#"+tabsIndex+"").val(fdfsFileInfoJSON);
	         }  
	     });  
	});	
	
	function initKindEditor() {
		var editor;
		editor = KindEditor.create('#article_add_editor', {
			basePath : '${contextPath}/resources/js/kindeditor/',
			items : [ 'source', '|', 'undo', 'redo', '|', 'preview',
					'template', 'code', 'cut', 'copy', 'paste',
					'plainpaste', 'wordpaste', '|', 'justifyleft',
					'justifycenter', 'justifyright', 'justifyfull',
					'insertorderedlist', 'insertunorderedlist', 'indent',
					'outdent', 'subscript', 'superscript', 'clearhtml',
					'quickformat', 'selectall', '|', 'fullscreen', '/',
					'formatblock', 'fontname', 'fontsize', '|',
					'forecolor', 'hilitecolor', 'bold', 'italic',
					'underline', 'strikethrough', 'lineheight',
					'removeformat', '|', 'image', 'table', 'hr',
					'emoticons', 'baidumap', 'pagebreak', 'anchor', 'link',
					'unlink', '|' ],
			uploadJson : '${contextPath}/image/upload',
			afterChange : function() {
				this.sync();
			}
		});
	}
	
	/** 图片删除按钮单击事件 */
	function delImage(){
		var checks = getImgContext().find("input:checked");
    	if(checks.length < 1){
    		alertMsg.warn("请选择图片！");
    		return;
    	}
    	
    	//函数变量
		var formFun = function(){
    		var tempDiv = null;
    		var imgDiv = null;
			for(var i = 0,len = checks.length;i < len;i++){
				tempDiv = $(checks[i]).parent().parent();
				tempDiv.css("display","none");
				imgDiv = tempDiv.find("img");
				var imageId = imgDiv.attr("imageId");
				console.info("imageId:" + imageId);
				var fdfsFileInfoJSON = $("#"+tabsIndex+"").val();
				if(typeof(imageId) == "undefined"){
					console.info("新增图片");
					//新增的图片
					var infos = imgInfos.split("&365");
					for(var i = 0; i < infos.length; i++){
						if(infos[i].indexOf(imageId) > -1){
							infos.splice(i,1);//删除第i个位置的元素，1表示删除一个元素
							isNew = true;
							break;
						}
					}
				}else{
					console.info("原有图片");
					imageId = "imageId=" + imageId;//方便后台操作
					//原有的图片
					if(fdfsFileInfoJSON == ""){
						fdfsFileInfoJSON = fdfsFileInfoJSON + imageId;
					}else{
						fdfsFileInfoJSON = fdfsFileInfoJSON + "&365" + imageId;
					}
				}
				$("#"+tabsIndex+"").val(fdfsFileInfoJSON);
			}
		}
		//确定框
		alertMsg.confirm("确定要删除图片？",{okCall: formFun});
	}
	
	/** 图片上传按钮单击事件 */
	/* function imgUpload(evt){
		var temp = $(evt);
		//获取后缀，并校验
		var vall = temp.val();
		var fileName = vall.substr(vall.lastIndexOf("\\")+1);
		var ext = vall.substr(vall.lastIndexOf(".")+1);
		if(!(ext && /^(jpg|jpeg|png|gif)$/.test(ext.toLowerCase()))){
    		alertMsg.warn("暂不支持jpg、gif、png、bmp以外的图片！");
			return false;
    	}
		//发起请求
		$.ajaxFileUpload({
			url : uploadPath,
	       	secureuri : false,
	       	fileElementId : temp.attr("id"),
	       	dataType : "json",
	      	success: function (da) {
	        	if(da.rs < 1){
	        		alertMsg.warn("图片上传失败："+da.msg);
					return false;
	        	}
	        	
	        	//$("#uploadFlag").val("123");
	        	//追加表单隐藏域
	        	//$("#imgIdContext").append(hiddHtml.replace("$name",title).replace("$uri",da.uri).replace("$imgId",da.imgId));
	        	//图片显示
	        	var imgContext = getImgContext();
	        	if(undefined != imgContext){
	        		imgContext.append(
	        			imgHtml.replace(/\$name/g,fileName)
	        				.replace(/\$imgName/g,da.imgName)
	        				.replace(/\$imgFlag/g,"+")
	        				.replace(/\$uri/g,groupURL+da.imgName)
	        			);
	        	}
	        },
	        error: function (data, status, e) {
	        	alertMsg.warn("图片上传失败，请稍后重试！");
	        	$("#uploadFlag").val("");
	        }
	    });
	} */
	
	/**提交表单之前的处理*/
	function fromHand(){
		console.info("tabsIndex:" + tabsIndex);
		var	dayRouteId = $("#"+tabsIndex+"").attr("dayrouteId");
		var fdfsFileInfoJSONList = $("#"+tabsIndex+"").val();
		console.info(fdfsFileInfoJSONList);
		if(fdfsFileInfoJSONList == ""){
			alert("未修改图片");
			return false;
		}
		console.info("lineId:" + $("#lineId").val());
		console.info("dayRouteId:" + dayRouteId);
		console.info("fdfsFileInfoJSONList:" + fdfsFileInfoJSONList);
		$("#fdfsFileInfoJSON").val(fdfsFileInfoJSONList);
		$("#dayRouteId").val(dayRouteId);
		return true;
	}
	
	/** 获取当前选项卡的索引 */
	function getTabsIndex(evt){
		tabsIndex = $(evt).index(".tabsHeaderContent li");
		console.info("tabsIndex:" + tabsIndex);
	}
	
	/** 获取当前的图片容器 */
	function getImgContext(){
		return $(".myTabsBody:eq("+tabsIndex+") .imgContext");
	}
	
	//取消回车键能提交表单的功能
	document.onkeydown = function(event_e){  
	 if(window.event) {  
	     event_e = window.event;  
	 }  
	 var int_keycode = event_e.charCode||event_e.keyCode;  
	 if(int_keycode =='13') {  //13是回车键
	     return false;  
	 }  
	}
</script>
