<#assign contextPath=springMacroRequestContext.getContextPath() />

<script src="${contextPath}/resources/js/calendar-widget/jquery.calendar-widget.js" type="text/javascript" charset="utf-8"></script>

<style>
	#datePrice td,th{border-left:1px solid #999;border-bottom:1px solid #999;width:90px;padding:10px 0;text-align:center}
	#datePrice table{border-right:1px solid #999;border-top:1px solid #999}th{background:#666;color:#fff}.other-month{background:#eee}
	  
	  .jq{background:#eee;font-weight:600;}
	  .jq span{margin-left:5px;}
	
	  .sa{ width:163px; background:#fff; border:1px solid #ccc; padding:10px 0px 10px; margin-left:62px;}
	  .sa ul {padding:0px ; margin:0px;}
	  .sa li{ list-style:none; padding:10px; margin-top:5px;}.sa li:hover{ background:#ccc;} li.current{ background:#ccc;}}
</style>


<script type="text/javascript">
	var path = '${contextPath}'

	$(document).ready(function(){
		
		var map = {};
		var date=new Date();
		//当前年份
		var y = date.getFullYear();
		var m = date.getMonth()+1;
		
		var show = function(){
			$('#datePrice').calendarWidget({month:m-1,year:y,cid:'c_'});//cid 日历input id的自定义前缀
		}
		
		var save = function(){
			$('.date-price').each(function(){
				if($(this).attr('id').indexOf('c_')>-1){
					var price = $(this).val();
					if(price.trim().length>0){
						map[$(this).attr('id')] = $(this).val();
					}else{
						delete map[$(this).attr('id')];
					}
				}
			});
		}
		
		var read = function(){
			$('.date-price').each(function(){
				if($(this).attr('id').indexOf('c_')>-1){
					$(this).val(map[$(this).attr('id')]);
				}
			});
		}
		
		//上个月
		$('#preMonthBtn').click(function(){
			if(--m<=0){
				y--;
				m=12;
			}
			
			save();
			show();
			read();
		});
		
		//下个月
		$('#nextMonthBtn').click(function(){
			if(++m>=13){
				y++;
				m=1;
			}
			save();
			show();
			read();
		});
		
		
		//解析后台返回基本价格价格日历  放入map
		//格式：20150312:100;20150313:101
		var priceArr = $("#priceStr").val().split(";");
		for(var p in priceArr){
			var priceArr2 = priceArr[p].split(":");
			if(priceArr2.length==2)
				map["c_"+priceArr2[0]] = priceArr2[1];
		}
		
		show();
		read();
		
		
		//绑定step1提交事件
		$("#submitBtn").click(function(){
			
			//复制编辑器内容到隐藏input 提交
			$("input[name='hiddenNotice']").attr("value", $("#notice", navTab.getCurrentPanel()).val());
			
			$("#f1").ajaxSubmit({
				type:"post",
				url:path+"/singleTicket/editSubmit",
				dataType:"json",
				beforeSubmit:function(){
					//校验参数
					var v = true;			
					
					if($("#name", navTab.getCurrentPanel()).val().trim().length<1){
						alertMsg.error("单票名称不能为空");
						v = false;
					}
					
					if($("#notice", navTab.getCurrentPanel()).val().trim().length<1){
						alertMsg.error("预订须知不能为空");
						v = false;
					}
					
					if($("#rackRate", navTab.getCurrentPanel()).val().trim().length<1){
						alertMsg.error("市场价格不能为空");
						v = false;
					}
					
// 					if($("#price", navTab.getCurrentPanel()).val().trim().length<1){
// 						alertMsg.error("参考价格不能为空");
// 						v = false;
// 					}
					
					if($("#remainingQty", navTab.getCurrentPanel()).val().trim().length<1){
						alertMsg.error("库存不能为空");
						v = false;
					}
					
					if($("input[type=radio]:checked").val()==3 && $("#returnCost3").val()==''){
						alertMsg.error("手续费不能为空");
						v = false;
					}
					
					if($("input[type=radio]:checked").val()==4 && $("#returnCost4").val()==''){
						alertMsg.error("手续费不能为空");
						v = false;
					}
					
					return v;
				},
				success:function(data){
					if(data.status==1){
						$('#step1').hide();$('#step2').show();
					}else if(data.status==-1){
						alertMsg.error(data.msg);
					}else{
						alertMsg.error("系统异常");
					}
				}	
			})
		})
		
		
		/**退票规则切换*/
		$("input[name='returnRule']").change(function(){
			if($(this).val()=='1'){
				$("#percent", navTab.getCurrentPanel()).attr("disabled", "disabled");
				$("#yuan", navTab.getCurrentPanel()).attr("disabled", "disabled");
				$("#percent", navTab.getCurrentPanel()).val("");
				$("#yuan", navTab.getCurrentPanel()).val("");
				
			}else if($(this).val()=='3'){//百分比
				$("#percent", navTab.getCurrentPanel()).removeAttr("disabled");
				$("#yuan", navTab.getCurrentPanel()).attr("disabled", "disabled");
				$("#yuan", navTab.getCurrentPanel()).val("");
			}else{
				$("#yuan", navTab.getCurrentPanel()).removeAttr("disabled");
				$("#percent", navTab.getCurrentPanel()).attr("disabled", "disabled");
				$("#percent", navTab.getCurrentPanel()).val("");
			}
		});
		
		//绑定基本价格日历提交事件
		$("#editDatePriceBtn").click(function(){
			//保存当前显示日历的内容
			save();
			//去除ID前缀
			var s = '';
			for(var key in map){
				s += key.replace('c_','')+':'+map[key]+';';
			}
			//提交
			$.ajax({
				type: "post",
				url: path+"/singleTicket/datePrice/update",
				cache:false,
				dataType:"json",
				data:{"ticketPolicyId":$("#ticketPolicyId").val(), "priceStr": s},
				success:function(data){
					if(data.status==1){
						alertMsg.correct("保存成功");
						navTab.closeCurrentTab();
						//刷新单票列表页
						navTab.reloadFlag("singleTicket")
					}else if(data.status==0){
						alertMsg.error(data.msg);
					}else if(data.status==-1){
						alertMsg.error("价格日历金额格式错误");
					}else if(data.status==-2){
						alertMsg.error("缺少基本价价格日历");
					}else{
						alertMsg.error("系统异常");
					}
					
				}
			})
		})
		
		
		$('input[type=radio]').change(function(){
			$('#returnCost3').val('');
			$('#returnCost4').val('');
		})
	})

	//搜索经销商
	function autoSearch(){
		$(".ac").hide();
		if($("#dealerName").val().length>0){
			$.ajax({
				type:"post",
				url:path+"/dealer/auotsearch",
				cache:false,
				dataType:"json",
				data:{"dealerName":$("#dealerName").val()},
				success:function(data){
					if(data.status==1){
						$(".sa").html(data.html);
						$(".sa ul li").click(function(){
							$("#dealerName").val($(this).text());
							//获取经销商ID
							var dealerId = $(this).children("input").val()
							
							var insert = true;
							$(".cl").each(function(){
								if($(this).val()==dealerId){
									alertMsg.error("该经销商已存在,请勿重复选择");
									insert = false;
								}
							})
							
							if(insert){
								//设置URL
								var l = path+"/singleTicket/showDealerDatePrice?dealerId="+dealerId+"&ticketPolicyId="+$("#ticketPolicyId").val()+"&dealerName="+$(this).text();
								
								//设置按钮URL
								$("#addBtn").attr("href", l);
							}
							
							//点击后隐藏 按钮  置空URL
							$("#addBtn").click(function(){
								$(".ac").hide();
								$("#addBtn").attr("href", "");
							})
							
							$(".sa").hide();
							
							if(insert){
								//显示按钮
								$(".ac").show();
							}
						});
						$(".sa").show();	
					}else{
						$(".sa").hide();
					}
				}
			})
		}else{
			$(".sa").hide();
		}
	}
	
	//删除经销商价格日历行
	function ajaxDelTr(obj, priceId){
		//priceId 价格日历ID
		$.ajax({
			type: "post",
			url: path+"/singleTicket/dealerDatePrice/del",
			cache:false,
			dataType:"json",
			data:{"datePriceId":priceId},
			success:function(data){
				if(data.status==1){
					$(obj).parent().parent().remove();
					//没有经销商价格日历记录时隐藏列表
					if($("#dtable tr").length<2)
						$("#dtable").hide();
				}else if(data.status==-1){
					alert("删除失败");
				}else{
					alert("系统异常");
				}
			}
		})
		return false;
	}
	
	function closeDialog(){
		if(confirm("是否取消修改该单票")){
			navTab.closeCurrentTab();
		}
	}
	
</script>


<div class="pageContent">
<div class="pageFormContent" layoutH="20" id="singleTicketContent">
	
	<!-- step1 -->
	<div id="step1">
		<form id="f1" method="post">
		
			<input type="hidden" id="ticketPolicyId" name="ticketPolicyId" value="${ticketPolicy.id}">
	
			<!-- 景区基本信息   -->
			<div class="jq unit" style="padding:8px 10px;margin-bottom:10px;"><span>基本信息</span></div>
			
			<div class="unit">
				<label>产品编号<span style="color: red">*</span>：</label>
				<input id="key" type="text" name="key" class="alphanumeric" value="${ticketPolicy.baseInfo.key}"/>
			</div>
			
			<div class="unit">
				<label>单票名称<span style="color: red">*</span>：</label>
				<input id="name" type="text" name="name" size="64" minlength="6" maxlength="20" value="${ticketPolicy.baseInfo.name}"/>
			</div>
			
			<div class="unit">
				<label>预定须知<span style="color: red">*</span>：</label>
				<textarea id="notice" class="editor" name="notice" rows="15" cols="90" maxlength="1000"
							tools="Fullscreen,Source,|,SelectAll,Cut,Copy,Pastetext,Blocktag,|,Fontface,FontSize,Bold,
							Italic,Underline,Strikethrough,FontColor,BackColor,|,Removeformat,Align,List,Outdent,Indent,
							Link,Unlink,Hr,Table">
					${ticketPolicy.baseInfo.notice}
				</textarea>
				<input type="hidden" name="hiddenNotice">
			</div>
			
			<!-- 价格、库存与有效期   -->
			<div class="jq unit" style="padding:8px 10px;margin-top:20px;margin-bottom:10px;"><span>价格、库存与有效期</span></div>
			
			<div class="unit">
				<label>市场价格<span style="color: red">*</span>：</label>
				<input id="rackRate" type="text" name="rackRate" class="isSpec" maxlength="10" value="${(ticketPolicy.baseInfo.rackRate)?c}"/>
			</div>
			
<!-- 			<div> -->
<!-- 				<label>参考价格<span style="color: red">*</span>：</label> -->
<!-- 				<input id="price" type="text" name="price" class="isSpec" maxlength="10" value=""/> -->
<!-- 			</div> -->
			
			<div class="unit">
				<label>库&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;存<span style="color: red">*</span>：</label>
				<input id="remainingQty" type="text" name="remainingQty" class="isSpec" value="${(ticketPolicy.sellInfo.remainingQty)?c}"/>
			</div>
			
			<div class="unit">
				<label>退票规则<span style="color: red">*</span>：</label>
				<input type="radio" name="returnRule" <#if ticketPolicy.sellInfo.returnRule==1 >checked="checked"</#if> value="1"/><span>不得退票</span>
			</div>
			
			<div class="unit">
			     <label>&nbsp;</label>  
			     	<span>
					<input type="radio" name="returnRule" <#if ticketPolicy.sellInfo.returnRule==3 >checked="checked"</#if> value="3"/>&nbsp;退票收取
					<input id="percent" name="returnCost" size="4"  <#if ticketPolicy.sellInfo.returnRule==3 >value='${ticketPolicy.sellInfo.returnCost}' <#else> disabled="disabled" </#if> class="isInject number" />
					&nbsp;%手续费
				</span>
			</div>
			
			<div class="unit">
			     <label>&nbsp;</label>
			     	<span>
					<input type="radio" name="returnRule" <#if ticketPolicy.sellInfo.returnRule==4 >checked="checked"</#if> value="4" class="addSpan"/>&nbsp;退票收取
					<input id="yuan" name="returnCost" size="4" <#if ticketPolicy.sellInfo.returnRule==4 >value="${ticketPolicy.sellInfo.returnCost}" <#else> disabled="disabled" </#if> class="isInject number" />
					&nbsp;元手续费
				</span> 
			</div>
		</form>
		
		<div class="formBar">
			<ul>
				<li>
					<div class="buttonActive"><div class="buttonContent"><button type="button" id="submitBtn">保存并编辑价格日历</button></div></div>
				</li>
				<li>
					<div class="button"><div class="buttonContent"><button type="button" onclick="closeDialog()" style="width: 35px;">取消</button>
					</div></div>
				</li>
			</ul>
		</div>
	</div>

	<!-- step2 -->
	<div id="step2" style="display: none;">
	
	  <form id="f2" action="${contextPath}/singleTicket/datePrice/save" onsubmit="return validateCallback(this, navTabAjaxDone)">
		<div class="jq unit" style="padding:8px 10px;margin-bottom:10px;"><span>基准价格价格日历</span></div>
		<div style="padding-left: 180px;">
				<input type="hidden" id="priceStr" value="${priceStr}">
				<input id="preMonthBtn" type="button" value="上个月"/>
				<input id="nextMonthBtn" type="button" value="下个月"/>
				</br></br>
		</div>
		
		<!-- 显示价格日历 -->
		<div id="datePrice" style="padding-left: 180px;"/>
		
	  </form>
		
		<div class="jq unit" style="padding:8px 10px;margin-bottom:10px; margin-top: 20px;"><span>经销商价格日历</span></div>
		<div style="padding-left: 180px;">
		
				<div class="unit">
			    	<label>经销商价格日历：</label>
			    	<input id="dealerName" name="dealerName" onkeyup="autoSearch()" autocomplete="off">
			    	<div class="sa" style="display: none; position: absolute; margin-left:130px; z-index: 99999;	" />
			    	<div class="ac" style="display: none; padding-left: 300px; margin-top: -18px; ">
			    		<a id="addBtn" href="" target="dialog" width="700" height="530">添加</a>
			    	</div>
			    </div>
			    
			    <!-- 已添加的经销商价格日历列表 -->
			    <div id="dtable_div" class="unit">
				    <table id="dtable"  width="350px;" id="table_caiwu" border="1" style='<#if (length<1)>display: none;</#if>' >
						<thead>
							<tr height="30px;">
								<th align="center" width="80px;" style="background-image: url('${contextPath}/resources/image/text2_u118.png');">经销商名称</th>
								<th align="center" width="50px;" style="background-image: url('${contextPath}/resources/image/text2_u118.png');">操作</th>
							</tr>
						</thead>
						<tbody>
							<#list dealerDatePriceList as dp>
							<tr height="30px;">
								<td>${dp.dealer.baseInfo.name}<input type="hidden" class="cl" value="${dp.dealer.id}"></td>
								<td align="center">
									<a onclick="ajaxDelTr(this, '${dp.id}')" href="javascript:void(0)">删除日历</a>&nbsp;&nbsp;&nbsp;
									<a target="dialog" href="${contextPath}/singleTicket/editDealerDatePrice?type=0&dealerId=${dp.dealer.id}&dealerName=${dp.dealer.baseInfo.name}&ticketPolicyId=${ticketPolicy.id}&priceId=${dp.id}" width="700" height="530">修改</a>
								</td>
							</tr>
							</#list>
						</tbody>
					</table>
			    </div>
		</div>
		 <div class="formBar">
					<ul>
						<li>
							<div class="buttonActive"><div class="buttonContent"><button id="editDatePriceBtn" type="button">提交</button></div></div>
						</li>
						<li>
							<div class="button"><div class="buttonContent"><button type="button" class="close">取消</button></div></div>
						</li>
					</ul>
		</div>
	</div>
	
	
</div>
</div>