<#assign contextPath=springMacroRequestContext.getContextPath() />
<link rel="stylesheet" href="${contextPath}/resources/js/trumbowyg/design/css/trumbowyg.css">
<div class="pageContent" style="text-align:left;">
	<form method="post" id="addForm" enctype="multipart/form-data" action="${contextPath}/couponActivity/addCoupon" class="pageForm required-validate" onsubmit="return custValidateForm(this);">
		<div class="pageFormContent" layoutH="58">
			<div class="unit">
				<label>*活动优先级：</label><a style="color:green;">&nbsp;&nbsp;&nbsp;只发放优先级最高的，数值越高，优先级越高。多个优先级相等的卡券都会发放。</a>
				<input size="12" type="text" name="priority" min="0" class="required digits " value="${(couponActivityDTO.issueConditionInfo.priority?c)!}" />
			</div>
			<div class="unit">
				<label>*活动名称：</label>
				<input type="text" name="name" size="64"   class="required" maxlength="40 " value="${(couponActivityDTO.baseInfo.name)!}"/>
			</div>
			<div class="unit">
				<label>*活动编号：</label>
				<input type="text" id="activityId" name="id" size="12"  class="required lettersonly" minlength="3" maxlength="3" value="${(couponActivityDTO.id)!}" <#if ((status)!0==1)>readonly="true"</#if>/> <a style="color:green;">&nbsp;&nbsp;&nbsp;3位英文，用于票券ID前三位</a>
			</div>
			<!-- 两个日期需要做关联限制 -->
			<div class="unit">
				<label>*活动有效期：</label>
				<input type="text" name="issueBeginDate" size="24"  class="date textInput readonly required issueBeginDate" datefmt="yyyy-MM-dd HH:mm:ss" value="${(couponActivityDTO.issueConditionInfo.issueBeginDate?string("yyyy-MM-dd HH:mm:ss"))!''}"/>
				<label>————</label>
				<input type="text" name="issueEndDate" size="24"  class="date textInput readonly required issueEndDate" datefmt="yyyy-MM-dd HH:mm:ss" value="${(couponActivityDTO.issueConditionInfo.issueEndDate?string("yyyy-MM-dd HH:mm:ss"))!''}"/>
			</div>
			<div class="unit">
				<label>卡券类别：</label>
				<select name="couponType" onchange="showShareKind(this)">
					<option value="1">代金券</option>
					<option value="2">现金券</option>
				</select>
			</div>
			<div class="unit" >
				<label>发放渠道：</label>
				<select name="issueWay" onchange="showWay(this)">
					<option value="1">注册</option>
					<option value="2">订单满</option>
					<option value="3">指定人员发放</option>
					<option value="4">赠券</option>
				</select>
			</div>
			<div class="unit" id="testHide"  class="issueNumLineD hide">
				<label>满</label>
				<input type="text" name="issueNumLine" class="required number" min="0" value="${(couponActivityDTO.issueConditionInfo.issueNumLine?c)!0}" />
				<label>元</label>
			</div>
			<div class="unit">
				<label>*面值：</label>
				<input type="text" id="faceValue" name="faceValue" min="0" accuracy="2"  size="64" class="required number" value="${(couponActivityDTO.baseInfo.faceValue?c)!}"/>元
				<a style="color:green;">&nbsp;&nbsp;&nbsp;面值在订单支付时可以抵用等额现金</a>
			</div>
			<div class="unit" >
				<label>*每人发放数量：</label>
				<input type="text" name="perIssueNumber"  size="12" class="required digits" min="1" value="${(couponActivityDTO.issueConditionInfo.perIssueNumber?c)!}"/>
			</div>
			<div class="unit" style="float:left;" >
				<label>*发放数量：</label>
				<input type="text" name="issueNumber" size="12" class="required digits" min="1" value="${(couponActivityDTO.issueConditionInfo.issueNumber?c)!}"/>
				<span>
				<input type="checkbox" name="nolimit" value="1"  />不限
				</span>
				<a style="color:green;">&nbsp;&nbsp;&nbsp;可设置发放数量</a>
			</div>
			
			
			<div class="unit" id="isSend">
			<label>*是否参与转赠活动：</label>
			<input type="radio" name="isSend" id="isSendY" value="true" checked="checked"/>可以转赠
			<input type="radio" name="isSend" id="isSendN" value="false" />不可以转赠
			</div>
			
			<div class="unit" >
			<label>*使用品类：</label>
			<input type="checkbox" name="usedKind" value="1" />机票
			</div>
			<div class="unit">
				<label>*使用条件：</label>
				<select name="condition" onchange="showCondition(this)">
					<option value="0">无</option>
					<option value="1">订单满</option>
				</select>
			</div>
			
			<div class="unit" id="shareKind">
				<label>*优惠同享：</label>
				同类别<input type="radio" name="isShareSameKind" id="isShareSameKindN" value="false" />不可叠加
					  <input type="radio" name="isShareSameKind" id="isShareSameKindY" value="true" checked="checked"/>可以叠加<br>
				
				不同类别<input type="radio" name="isShareNotSameType" id="isShareNotSameTypeN"value="false" />不可叠加
					  <input type="radio" name="isShareNotSameType" id="isShareNotSameTypeY"value="true" checked="checked"/>可以和代金券叠加
			</div>
			
			
			<div class="unit" id="conditionD" class="conditionD hide">
				<label>满</label>
				<input type="text" name="minOrderPrice" class="required number" min="0" value="${(couponActivityDTO.useConditionInfo.minOrderPrice?c)!0}" />
				<label>元</label>
			</div>
			<div class="unit">
				<label>*使用有效期：</label>
				<input type="text" name="beginDate" size="24"  class="date textInput readonly required beginDate" datefmt="yyyy-MM-dd HH:mm:ss" value="${(couponActivityDTO.useConditionInfo.beginDate?string("yyyy-MM-dd HH:mm:ss"))!''}" />
				<label>————</label>
				<input type="text" name="endDate" size="24"  class="date textInput readonly required endDate" datefmt="yyyy-MM-dd HH:mm:ss" value="${(couponActivityDTO.useConditionInfo.endDate?string("yyyy-MM-dd HH:mm:ss"))!''}"/>
			</div>
			<div class="unit">
				<label>*使用规则：</label><br>
				<textarea id="simple-editor" name="ruleIntro" >
                    ${(couponActivityDTO.baseInfo.ruleIntro)!}
                </textarea>
			</div>
		</div>
		<div class="formBar">
			<ul>
				<li><div class="buttonActive"><div class="buttonContent"><button type="submit">提交</button></div></div></li>
				<li><div class="button"><div class="buttonContent"><button type="button" class="close">取消</button></div></div></li>
			</ul>
		</div>
	</form>
</div>
		<script src="${contextPath}/resources/js/trumbowyg/trumbowyg.js"></script>
        <script src="${contextPath}/resources/js/trumbowyg/langs/zh.js"></script>
        <script src="${contextPath}/resources/js/trumbowyg/plugins/upload/trumbowyg.upload.js"></script>
        <script src="${contextPath}/resources/js/trumbowyg/plugins/base64/trumbowyg.base64.js"></script>
<script>
      //全屏提示错误信息的方法
      //alertMsg.error("xxxx");
      $(function(){
      	$("#testHide").hide();
      	$("#conditionD").hide();
    	$("#shareKind").hide();
    	$("#isSend").hide();
      	//初始化数据
      	$("#addForm select[name=issueWay] option[value=${((couponActivityDTO.issueConditionInfo.issueWay)!0)?c}]").prop("selected",true);
      	$("#addForm select[name=issueWay]").change();
      	$("#addForm select[name=couponType] option[value=${(couponActivityDTO.baseInfo.couponType?c)!}]").prop("selected",true);
        $("#addForm select[name=couponType]").change();
      	$("#addForm select[name=condition] option[value=${(couponActivityDTO.useConditionInfo.condition?c)!}]").prop("selected",true);
      	$("#addForm select[name=condition]").change();
    	      	
      	if('${(nolimit)!0}'==1){
      		$("#addForm input[name=nolimit][value=1]").click();
      		$("#addForm input[name=issueNumber]").attr("readonly",true).val("9999999");
      	}
      	
      	var userKind = '${(couponActivityDTO.useConditionInfo.usedKind)!""}';
      	if(userKind!=""){
      		var kinds = userKind.split(",");
      		for(var x in kinds){
      			$("#addForm input[name=usedKind][value="+kinds[x]+"]").click();
      		}
      	}
      	
      	$("#addForm input[name=nolimit]").on("change",function(){
      		if($(this).prop("checked")==true){
      			$("#addForm input[name=issueNumber]").attr("readonly",true).val("9999999");
      		}else{
      			$("#addForm input[name=issueNumber]").attr("readonly",false).val("0");
      		}
      	});
      });
      //订单满的框架显示
      $(".issueNumLineD").hide();
      function showWay(se){
      	var id = $(se).val();
      	if(id==2){
      		$("#testHide").show();
      	}else{
      		$("#testHide").hide();
      		//这个值还是不要去掉了，防止修改的时候不方便
      		//$("input[name=issueNumLine]").val("");
      	}
      }

      function showCondition(se){
      	var id = $(se).val();
      	if(id==1){
      		$("#conditionD").show();
      	}else{
      		$("#conditionD").hide();
      		//$("input[name=minOrderPrice]").val("");
      	}
      }
      //自主校验form
      function custValidateForm(fr){
      	//验证id是否存在
      	var id = $("#activityId").val();
      	//校验使用品类至少选择了一个
      	var num = $("input[name=usedKind]:checked",fr).length;
      	if(num==0){
      		alertMsg.error("至少选择一个使用品类");
      		return false;
      	}
      	
      	//判断每人发放数量和总发放数量的关系
      	var perIssueNumber = $("input[name=perIssueNumber]",fr).val();
      	var issueNumber = $("input[name=issueNumber]",fr).val();
      	if(issueNumber.length>10){
      		alertMsg.error("发放数量长度错误");
  			return false;
      	}
      	if(/^[0-9]+$/.test(perIssueNumber)&&/^[0-9]+$/.test(issueNumber)){
      		var a1 = parseInt(issueNumber);
      		var a2 = parseInt(perIssueNumber);
      		if(a1<a2){
      			alertMsg.error("总发放数量必须大于每人发放数量");
      			return false;
      		}
      		if((a1%a2)!=0){
      			alertMsg.error("每人发放数量必须能被总发放数量整除");
      			return false;
      		}
      	}
      	
      	//验证面值，订单满的精度
      	var faceValue = $("#faceValue",fr).val();
      	if(faceValue!=""&&!/^[0-9]+(.[0-9]{0,2})?$/.test(faceValue)){
      		alertMsg.error("请输入正确的面值");
      		return false;
      	}
      	var issueNumLine = $("input[name=issueNumLine]",fr).val();
      	if(issueNumLine!=""&&!/^[0-9]+(.[0-9]{0,2})?$/.test(issueNumLine)){
      		alertMsg.error("请输入正确的发放限额");
      		return false;
      	}
      	
      	var minOrderPrice = $("input[name=minOrderPrice]",fr).val();
      	if(minOrderPrice!=""&&!/^[0-9]+(.[0-9]{0,2})?$/.test(minOrderPrice)){
      		alertMsg.error("请输入正确的使用限额");
      		return false;
      	}
      	
      	//验证日期的大小关系
      	//活动时间
      	var issueBeginDate = $('.issueBeginDate').val();
      	var issueEndDate = $('.issueEndDate').val();
      	if(issueBeginDate!=""&&issueEndDate!=""){
      		if(!comptime(issueBeginDate, issueEndDate)){
      			alertMsg.error("活动开始时间不能大于活动结束事件");
      			return false;
      		}
      	}
      	//使用有效期
      	var beginDate = $('.beginDate').val();
      	var endDate = $('.endDate').val();
      	if(beginDate!=""&&endDate!=""){
      		if(!comptime(beginDate, endDate)){
      			alertMsg.error("使用有效期开始时间不能大于活动结束事件");
      			return false;
      		}
      	}
      	
      	//id不为空，且不是修改页面
      	if(id!=""&&'${(status)!}'!=1){
      		var result;
      		$.ajax({
      	 		type: "get",
      	 		url:"${(contextPath)!}/couponActivity/examCoupon?id="+id,
      	 		async: false,
      	 	    error: function(request) {
      	 	        alert("连接失败");
      	 	    },
      	 	    success: function(data) {
      	 	    	result = eval('('+data+')');
      	 	    }
      	 	});
      		if(!result.result){
      			alertMsg.error("活动编号已经存在");
      			return false;
      		}
      	}
      
      	return validateCallback(fr, custAjaxDone);
      }

      /**
       * 自定义处理ajax的方法
       */
       function custAjaxDone(json){
    		
      		DWZ.ajaxDone(json);
      		if (json.statusCode == DWZ.statusCode.ok){
      			if (json.navTabId){ //把指定navTab页面标记为需要“重新载入”。注意navTabId不能是当前navTab页面的
      				navTab.reloadFlag(json.navTabId);
      			} else { //重新载入当前navTab页面
      				var $pagerForm = $("#pagerForm", navTab.getCurrentPanel());
      				var args = $pagerForm.size()>0 ? $pagerForm.serializeArray() : {}
      				navTabPageBreak(args, json.rel);
      			}
      			
      			if ("closeCurrent" == json.callbackType) {
      				setTimeout(function(){navTab.closeCurrentTab(json.navTabId);}, 100);
      			} else if ("forward" == json.callbackType) {
      				navTab.reload(json.forwardUrl);
      			} else if ("forwardConfirm" == json.callbackType) {
      				alertMsg.confirm(json.confirmMsg || DWZ.msg("forwardConfirmMsg"), {
      					okCall: function(){
      						navTab.reload(json.forwardUrl);
      					}
      				});
      			} else if ("openNew" == json.callbackType) {
      				navTab.openTab(json.navTabId, '${contextPath}/couponActivity/couponManage',{title:"卡券活动管理", fresh:true, external:false});
      				navTab.closeTab("addCoupon");
      			} else {
      				navTab.getCurrentPanel().find(":input[initValue]").each(function(){
      					var initVal = $(this).attr("initValue");
      					$(this).val(initVal);
      				});
      			}
      		}

      	
       }

      $("#simple-editor").trumbowyg({
      	fullscreenable:false,
          lang: 'zh',
          closable: false,
          btns: ['viewHTML',
                 '|', 'formatting',
                 '|', 'bold',
                 '|', 'italic',
                 '|', 'strikethrough',
                 '|', 'underline',
                 '|', 'justifyLeft',
                 '|', 'justifyCenter',
                 '|', 'justifyRight',
                 '|', 'justifyFull',
                 '|', 'unorderedList',
                 '|', 'orderedList',
                 '|', 'horizontalRule']
      });

      /**
      *	比较时间
      */
      function comptime(beginTime,endTime) {
          var beginTimes = beginTime.substring(0, 10).split('-');
          var endTimes = endTime.substring(0, 10).split('-');

          //火狐不支持日期中间用"-"隔断，要用"/"替换
          beginTime = beginTimes[1] + '/' + beginTimes[2] + '/' + beginTimes[0] + ' ' + beginTime.substring(10, 19);
          endTime = endTimes[1] + '/' + endTimes[2] + '/' + endTimes[0] + ' ' + endTime.substring(10, 19);

          var a = (Date.parse(endTime) - Date.parse(beginTime)) / 3600 / 1000;
          if (a < 0) {
              return false;
          } else if (a > 0) {
              return true;
          } else if (a == 0) {
              return false;
          }
      }
      
      /**
      *现金券时 显示优惠同享和是否转赠，代金券不显示
      */
     
      function showShareKind(se){
    	  var couponType= $(se).val();
    	  if(couponType=='1'){
    		  $("#shareKind").hide();
    		  
    		  $("#isShareSameKindY").removeAttr("checked");
    		  $("#isShareSameKindN").attr("checked","checked");
    		  
    		  
    		  $("#isShareNotSameTypeY").removeAttr("checked");
    		  $("#isShareNotSameTypeN").attr("checked","checked");
    		      		 
    		   $("#isSend").hide();
    		  $("#isSendY").removeAttr("checked");
    		  $("#isSendN").attr("checked","checked");
    		  
    	  }else if(couponType=='2'){
    		  
    		  $("#shareKind").show();
    		  
    		  $("#isShareSameKindY").removeAttr("checked");
    		  $("#isShareSameKindY").attr("checked","checked");
    		  
    		  $("#isShareNotSameTypeY").removeAttr("checked");
    		  $("#isShareNotSameTypeY").attr("checked","checked");
    		  
    		  $("#isSend").show();
    		  $("#isSendY").removeAttr("checked");
    		  $("#isSendY").attr("checked","checked");
    	  }
      }
      
           
        </script>
