<#assign contextPath=springMacroRequestContext.getContextPath() /> <#assign inputType="hidden" /> <#assign tableBorder="0" /> <#assign requiredTag="
<a style=\"color:#FF0000\">*</a>
" />


<style type="text/css">
table.fix1425364102240 td{
height: auto;
padding-bottom: 9px;
padding-right: 29px;

 
}
</style>
<link href="${contextPath}/resources/css/ajaxfileupload.css" rel="stylesheet" type="text/css" media="print" />
<script src="${contextPath}/resources/js/ajaxfileupload.js" type="text/javascript"></script>
<script type="text/javascript">

function checkUploadPic(obj){
	var maxSize = 2000;//单位kb
	
    photoExt=obj.value.substr(obj.value.lastIndexOf(".")).toLowerCase();//获得文件后缀名
    if(photoExt!='.jpg' && photoExt!='.jpeg' && photoExt!='.bmp' && photoExt!='.png'){
        alertMsg.warn("请上传格式为jpg、jpeg、png、bmp格式且小于2兆的照片!");
        obj.value='';
        return false;
    }
    var fileSize = 0;
    var isIE = /msie/i.test(navigator.userAgent) && !window.opera;            
    if (isIE && !obj.files) {          
         var filePath = obj.value;            
         var fileSystem = new ActiveXObject("Scripting.FileSystemObject");   
         var file = fileSystem.GetFile (filePath);               
         fileSize = file.Size;         
    }else {  
         fileSize = obj.files[0].size;     
    } 
    fileSize=Math.round(fileSize/1024*100)/100; //单位为KB
    if(fileSize>=maxSize){
    	alertMsg.warn("照片最大尺寸为"+maxSize+"KB，请重新上传!");
    	obj.value=''
        return false;
    }
    
    return true;
}
$(document).ready(function(){
	hideSupplierSubTab();
	dbp("ready@"+$("#supplierId").val());
	if($("#supplierId").val()==''){
		return;
	}
		showSupplierSubTab();
});
function hideSupplierSubTab(){
	$("#sub_tab_supplier_2").hide();
	$("#sub_tab_supplier_3").hide();
}
function showSupplierSubTab(){
	var s=300;
	$("#sub_tab_supplier_2").delay(200).fadeIn(s);
	$("#sub_tab_supplier_3").delay(400).fadeIn(s);
}


	function ajaxSubmitSupplierBaseInfo() {
		
		
		//判断表单
		if ($("#name").val() == "") {
			alertMsg.error("请填写供应商名称");
			return;
		}
		
		//基本信息id
		if ($("#supplierId").val() != '') {
			ajaxUpdateSupplierBaseinfo();
			return false;
		}
		
		$.ajax({
			cache : false,
			type : "POST",
			url : "${contextPath}/supplier/create",
			data : $('#supplierBaseinfoForm').serialize(),
			dataType : 'json',
			async : false,
			error : function(request) {
				alert("发送请求失败！");
			},
			success : function(data) {
				if(data.result=="success"){
					$("[name='supplierId']").each(function(){
						$(this).val(data.supplierId);
					});
					$("[rel='supplierId']").each(function(){
						$(this).val(data.supplierId);
					});
					
					alertMsg.correct("保存成功");
					showSupplierSubTab();
					
				}else if(data.result =="error"){
					alertMsg.error(data.message);
				}
			}
		});
	}
	function reloadSupplierList(){
		navTab.closeCurrentTab();
		navTab.openTab("supplier_list", "${contextPath}/supplier/list", { title:"供应商列表"});

	}
	function ajaxUpdateLinkman() {
		if($("[name='supplierLinkManList[0].name']").val()==''){
			alertMsg.error("主要联系人姓名必填");
			return false;
		}
		
		//基本信息id
		if(!supplierBaseInfoIsSubmit()){
			alertMsg.warn("请先保存商品基本信息");
			return false;
		}
		
		$.ajax({
			cache : false,
			type : "POST",
			url : "${contextPath}/supplier/linkman/update",
			data : $('#linkmanForm').serialize(),
			dataType : 'json',
			async : false,
			error : function(request) {
				alert("发送请求失败！");
			},
			success : function(data) {
				if(data.result =='success'){
			        var str=data.ids;
			        var strArray = str.split(';');
			        for(var ii =0 ;ii<strArray.length;ii++)
			        {
			            if(strArray[ii] != null && strArray[ii].length > 0)
			            {
			                $("[name='supplierLinkManList["+ii+"].supplierLinkManId']").val(strArray[ii]);
			            }
			        }
					alertMsg.correct("保存成功");
				}else{
					alert('err@ajaxUpdateLinkman()@data.result!=\"success\"')
				}
			}
		});
	}
	function ajaxUpdateSupplierBaseinfo() {
		

		$.ajax({
			cache : false,
			type : "POST",
			url : "${contextPath}/supplier/update",
			data : $('#supplierBaseinfoForm').serialize(),
			dataType : 'json',
			async : false,
			error : function(request) {
				alert("发送请求失败！");
			},
			success : function(data) {
				
				if(data.result == "success"){
					alertMsg.correct("保存成功");
				}else if(data.result == "error"){
					alertMsg.error(data.message);
				}
			}
		});
	}
	
	
	function addTable(){
		var i=0;
		while( $("#linkman"+i).length>0 ){
			i++;
			if(i>50){
				return;
			}
		}
//		$("#linkManTable").append("<br>其他联系人：<br>");
		$("#linkManTable").append("<table class=\"linkman_table\" id=\"linkmanTable"+i+"\">       <tbody><tr>        <td colspan=\"2\">其他联系人：               <input  type=\"${inputType}\" name=\"supplierLinkManList["+i+"].supplierLinkManId\" id=\"linkman"+i+"\" >                </td><td>       </td></tr>       <tr>        <td>姓名</td>        <td><input maxlength=\"10\"  type=\"text\" name=\"supplierLinkManList["+i+"].name\" onchange=\"this.value=trim(this.value);\" class=\"textInput\">        </td>        <td>职务</td>        <td><input type=\"text\" maxlength=\"10\" name=\"supplierLinkManList["+i+"].post\"  class=\"textInput\">        </td>        <td rowspan=\"3\"><input type=\"button\" value=\"删除联系人\" onclick=\"ajaxDeleteLinkman("+i+")\"></td>       </tr>       <tr>        <td>手机</td>        <td><input type=\"text\" name=\"supplierLinkManList["+i+"].mobile\" maxlength=\"11\" onchange=\"this.value=checkPhone(this.value)\" class=\"textInput\">        </td>        <td>联系电话</td>        <td><input type=\"text\" name=\"supplierLinkManList["+i+"].phone\"  onchange=\"this.value=checkPhone(this.value)\" class=\"textInput\">        </td>       </tr>       <tr>        <td>联系QQ</td>        <td><input type=\"text\" name=\"supplierLinkManList["+i+"].QQ\"  onchange=\"this.value=checkPhone(this.value)\" class=\"textInput\">        </td>        <td>联系邮箱</td>        <td><input type=\"text\" maxlength=\"100\"  name=\"supplierLinkManList["+i+"].email\"  onchange=\"checkEm(this)\" class=\"textInput\">        </td>       </tr><tr><td></td></tr></tbody></table>");
	}
	
	function supplierBaseInfoIsSubmit(){
		if($("#supplierId").length<=0){
			alert("err@表单元素不存在");
			return false;
			
		}
		
		if($("#supplierId").val() == ''){
			return false;
		}
		return true;
	}
	
	function ajaxDoneUpdateSupplierAptitude(result){
		if(result.status == "success"){
			alertMsg.correct("保存成功");
		}		
		
	}
	
	function validateSubmitUpdateSupplierAptitude(formElement,cb) {

		if(!supplierBaseInfoIsSubmit()){
			alertMsg.warn("请先保存商品基本信息");
			return false;
		}
		return validateCallback(formElement, cb);
	}
	
	function ajaxUploadImg(imgElemntId,imgIdElementId,fileElement,type){
		if(!checkUploadPic(fileElement)){
			return false;
		}
		var imgId = '';
		var pId = $("[name='supplierId']").val();
		dbp("function:ajaxUploadImg()@pId="+pId);
		if(!pId){
			alertMsg.warn('请保存基本信息');
			$(fileElement).val('');
			return false;
		}
		$.ajaxFileUpload({
			url:'${contextPath}/system/upload/upload_img_supplier',
			secureuri : false,
			async:false,
			fileElementId : $(fileElement).attr('id'),
			data:{
				imageType:type,
				supplierId:pId,
				supplierAptitudeImageId:$("#"+imgIdElementId).val()
			},
			dataType : 'json',
			success: function (data, status) {
				$("#"+imgElemntId).attr("src","${contextPath}"+data.imgUrl);
				$("#"+imgIdElementId).val(data.imgId);
	        }

	    });
	}
	
	function ajaxDeleteLinkman(tableId){
		var linkmanId = $("#linkman"+tableId).val();
		if(linkmanId ==''){
			$("#linkmanTable"+tableId).empty();
			return;
		}
		
		
		$.ajax({
			cache : false,
			type : "POST",
			url : "${contextPath}/supplier/linkman/delete",
			data : {
				supplierLinkManId:linkmanId,
			},
			dataType : 'json',
			async : false,
			error : function(request) {
				alert("发送请求失败！");
			},
			success : function(data) {
				if(data.result == "success"){
					alertMsg.correct("删除成功");
					$("#linkmanTable"+tableId).empty();				
				}else if(data.result == "error"){
					alertMsg.error("删除失败");
				}
			}
		});
		
	}
	
	
	
</script>
<div class="pageContent">
	<div class="tabs" currentIndex="0" eventType="click">
		<div class="tabsHeader">
			<div class="tabsHeaderContent">
				<ul>
					<li><a href="javascript:;">
							<span>供应商基本信息</span>
						</a></li>
					<li id="sub_tab_supplier_2"><a href="javascript:;">
							<span>供应商联系人信息</span>
						</a></li>
					<li id="sub_tab_supplier_3"><a href="javascript:;">
							<span>供应商资质</span>
						</a></li>
				</ul>
			</div>
		</div>
		<div class="tabsContent" layoutH="75" style="background:#F9F9F9">
			<!-- ------------------------------------------------------------------------- -->
			<div>
				<form id="supplierBaseinfoForm" rel="supplierBaseinfoForm" method="post" >
					<table border="${tableBorder}" class="my_form fix1425364102240">
						<tr>
							<td>供应商名称${requiredTag}</td>
							<td style="width:250px"><input type="text" name="name" id="name" value="${(supplier.baseInfo.name)!}" onchange="removeAllEmpty(this)" maxlength="20" />
							</td>
							
												<td>供应商编码：</td>
					<td>
						<input type="text" maxlength="50" name="supplierCode" value="${(supplier.supplierCode)!}"   />
					</td>
							
							
						</tr>
						<tr>

							</td>
							<td>开户银行</td>
							<td><input type="text" name="bank" value="${(supplier.baseInfo.bank)!}" maxlength="50"/>
							</td>
							<td>账号</td>
							<td><input type="text" name="account" value="${(supplier.baseInfo.account)!}" maxlength="20" /></td>
						</tr>
						<tr>
													<td>供应商类型</td>
							<td><select name="type">
									<option value="0" >经销</option>
									<option value="1" 
									<#if (supplier.baseInfo.type)?? >
									<#if (supplier.baseInfo.type)==1 >
										selected="selected"
										</#if>
									</#if>
									>代销</option>
							</select>
							<td>联系电话</td>
							<td><input type="text" name="phone" value="${(supplier.contact.phone)!}" onchange="this.value=checkPhone(this.value)" />
							</td>
							
						</tr>
						
						<tr>
							<td>联系地址</td>
							<td colspan="3"><input type="text" name="address" value="${(supplier.contact.address)!}" maxlength="100" style="width:450px"/></td>
						</tr>
						<tr>
							<td>邮编号码</td>
							<td><input type="text" name="postCode" value="${(supplier.contact.postCode)!}" onchange="this.value=checkPhone(this.value)" maxlength="6"/>
							</td>
							<td>联系邮箱</td>
							<td><input type="text" name="email" id="textfield10" value="${(supplier.contact.email)!}" onchange="checkEm(this)" maxlength="100" /></td>
						</tr>
						<tr>
							<td>传真号码</td>
							<td><input type="text" name="fax" id="textfield5" value="${(supplier.contact.fax)!}" onchange="this.value=checkPhone(this.value)" />
							</td>
							<td>公司网址</td>
							<td><input type="text" name="URL" id="textfield11" value="${(supplier.baseInfo.URL)!}" maxlength="255"/></td>
						</tr>
						<tr>
							<td>法人姓名</td>
							<td><input type="text" name="legalPerson" id="textfield6" value="${(supplier.baseInfo.legalPerson)!}" maxlength="10" />
							</td>
							<td>税务号</td>
							<td><input type="text" name="tax" id="textfield12" value="${(supplier.baseInfo.tax)!}" maxlength="20" /></td>
						</tr>
						<tr>
							<td>注册资金</td>
							<td><input type="text" name=registeredCapital id="textfield7" class="number" value="<#if (supplier)><#if (supplier.baseInfo.registeredCapital)>${(supplier.baseInfo.registeredCapital)?c}</#if></#if>" onchange="this.value=checkNumberA(this.value,0,65000)" placeholder="（万元/人民币）"/> </td>
							<td>成立时间</td>
							<td><input name="establishDate" type="text" class="date" readonly="readonly" onclick="setday(this);" datefmt="yyyy-MM-dd" value="${(supplier.baseInfo.establishDate)!'2014-01-01'}" />
							</td>
						</tr>
						<tr>
							<td height="100">备注信息</td>
							<td colspan="3" style="width:450px"><textarea name="remark" id="textarea" cols="70" rows="3" maxlength="250">${(supplier.remark)!}</textarea>
							</td>
						</tr>
					</table>
					<input type="${inputType}" id="supplierId" name="supplierId" value="${(supplier.id)!}" />
					<div class="divider"></div>
					<a class="buttonActive" onclick="ajaxSubmitSupplierBaseInfo()">
						<span>保存</span>
					</a>
					<div class="divider"></div>
				</form>
			</div>
			<!-- ------------------------------------------------------------------------- -->
			<div>
				<form id="linkmanForm" rel="linkmanForm" method="post">
					<input type="${inputType}" name="supplierId" value="${(supplier.id)!}" />
					<div id="linkManTable">
						<#if (linkmanList)?? && (linkmanList?size > 0) > <#list linkmanList as t>
						<table class="linkman_table" id="linkmanTable${t_index}">
							<tr>
								<td colspan="2"><#if t_index=0>常用联系人： <#else>其他联系人： </#if>
														<input type="${inputType}" name="supplierLinkManList[${t_index}].supplierLinkManId" id="linkman${t_index}" value="${t.id}" />
								
								<td>
							</tr>
							<tr>
								<td>姓名<#if t_index=0>${requiredTag}</#if></td>
								<td><input type="text" name="supplierLinkManList[${t_index}].name" value="${t.name}" onchange="this.value=trim(this.value);" maxlength="10"/>
								</td>
								<td>职务</td>
								<td><input type="text" name="supplierLinkManList[${t_index}].post" value="${t.post}" maxlength="10"/>
								</td>
								<#if t_index !=0>
								<td rowspan="3"><input type="button" value="删除联系人" onclick="ajaxDeleteLinkman(${t_index})" /></td>
								</#if>
							</tr>
							<tr>
								<td>手机</td>
								<td><input type="text" name="supplierLinkManList[${t_index}].mobile" value="${t.mobile}" onchange="this.value=checkPhone(this.value)" maxlength="11"/>
								</td>
								<td>联系电话</td>
								<td><input type="text" name="supplierLinkManList[${t_index}].phone" value="${t.phone}" onchange="this.value=checkPhone(this.value)" />
								</td>
							</tr>
							<tr>
								<td>联系QQ</td>
								<td><input type="text" name="supplierLinkManList[${t_index}].QQ" value="${t.QQ}" onchange="this.value=checkPhone(this.value)" />
								</td>
								<td>联系邮箱</td>
								<td><input type="text" name="supplierLinkManList[${t_index}].email" value="${t.email}" onchange="checkEm(this)" maxlength="100"/>
								</td>
							</tr>
							<tr><td></td></tr>
						</table>
						</#list> <#else>
						<table class="linkman_table">
													<tr>
								<td colspan="2">常用联系人：
						<input type="${inputType}" name="supplierLinkManList[0].supplierLinkManId" id="linkman0"  />
						
								
								<td>
							</tr>
							<tr>
							
							
								<td>姓名${requiredTag}</td>
								<td><input type="text" name="supplierLinkManList[0].name" maxlength="10" />
								</td>
								<td>职务</td>
								<td><input type="text" name="supplierLinkManList[0].post" maxlength="10" />
								</td>
							</tr>
							<tr>
								<td>手机</td>
								<td><input type="text" name="supplierLinkManList[0].mobile" onchange="this.value=checkPhone(this.value)" maxlength="11"/>
								</td>
								<td>联系电话</td>
								<td><input type="text" name="supplierLinkManList[0].phone" onchange="this.value=checkPhone(this.value)" />
								</td>
							</tr>
							<tr>
								<td>联系QQ</td>
								<td><input type="text" name="supplierLinkManList[0].QQ" onchange="this.value=checkPhone(this.value)" />
								</td>
								<td>联系邮箱</td>
								<td><input type="text" name="supplierLinkManList[0].email" onchange="checkEm(this)" maxlength="100"/>
								</td>
							</tr>
							<tr><td></td></tr>
						</table>
						

						
						</#if>
					</div>
					<div class="divider"></div>
					<a class="buttonActive" onclick="ajaxUpdateLinkman()" style="display: inline-block;padding-right: 30px;">
						<span>保存</span>
					</a>
					<a class="buttonActive" onclick="addTable()" style="display: inline-block;padding-right: 30px;">
						<span style="width: 105px;">添加其他联系人</span>
					</a>
					<div class="divider"></div>
				</form>
			</div>
			<!-- ------------------------------------------------------------------------- -->
			<div>
				<table border="${tableBorder}" class="pic_view">
					<tr>
						<td><img id="imgSrc0" height="120px" width="120px" src="<#if (imgSrc1)??> ${contextPath}${imgSrc1} <#else>${contextPath}/resources/image/sys/no_img.jpg</#if>" alt="" />
						</td>
						<td>营业执照：<br /> <input id="imageFile1" name="imageFile" type="file" onchange="ajaxUploadImg('imgSrc0','imgId0',this,1)" />
						</td>
						<td><img id="imgSrc1" height="120px" width="120px" src="<#if (imgSrc2)??> ${contextPath}${imgSrc2} <#else>${contextPath}/resources/image/sys/no_img.jpg</#if>" alt="" />
						</td>
						<td>税务登记证：<br /> <input id="imageFile2" name="imageFile" type="file" onchange="ajaxUploadImg('imgSrc1','imgId1',this,2)" />
						</td>
					</tr>
					<tr>
						<td><img id="imgSrc2" height="120px" width="120px" src="<#if (imgSrc3)??> ${contextPath}${imgSrc3}<#else>${contextPath}/resources/image/sys/no_img.jpg </#if>" alt="" />
						</td>
						<td>法人身份证：<br /> <input id="imageFile3" name="imageFile" type="file" onchange="ajaxUploadImg('imgSrc2','imgId2',this,3)" />
						</td>
						<td><img id="imgSrc3" height="120px" width="120px" src="<#if (imgSrc4)??> ${contextPath}${imgSrc4}<#else>${contextPath}/resources/image/sys/no_img.jpg </#if>" alt="" />
						</td>
						<td>授权书：<br /> <input id="imageFile4" name="imageFile" type="file" onchange="ajaxUploadImg('imgSrc3','imgId3',this,4)" />
						</td>
					</tr>
					<tr>
						<td><img id="imgSrc4" height="120px" width="120px" src="<#if (imgSrc5)??> ${contextPath}${imgSrc5}<#else>${contextPath}/resources/image/sys/no_img.jpg </#if>" alt="" />
						</td>
						<td>资质认证：<br /> <input id="imageFile5" name="imageFile" type="file" onchange="ajaxUploadImg('imgSrc4','imgId4',this,5)" />
						</td>
						<td><img id="imgSrc5" height="120px" width="120px" src="<#if (imgSrc6)??> ${contextPath}${imgSrc6}<#else>${contextPath}/resources/image/sys/no_img.jpg </#if>" alt="" />
						</td>
						<td>其他证书：<br /> <input id="imageFile6" name="imageFile" type="file" onchange="ajaxUploadImg('imgSrc5','imgId5',this,6)" />
						</td>
					</tr>
				</table>
				<form id="productPicForm" method="post" onsubmit="return validateSubmitUpdateSupplierAptitude(this,ajaxDoneUpdateSupplierAptitude)" action="${contextPath}/supplier/update_supplier_aptitude">
					<input type="${inputType}" name="" id="imgId0" value="${(imgId1)!}">
					<input type="${inputType}" name="" id="imgId1" value="${(imgId2)!}">
					<input type="${inputType}" name="" id="imgId2" value="${(imgId3)!}">
					<input type="${inputType}" name="" id="imgId3" value="${(imgId4)!}">
					<input type="${inputType}" name="" id="imgId4" value="${(imgId5)!}">
					<input type="${inputType}" name="" id="imgId5" value="${(imgId6)!}">
					<input type="${inputType}" name="supplierId" value="${(supplier.id)!}">
				</form>
			</div>
		</div>
		<div class="tabsFooter">
			<div class="tabsFooterContent"></div>
		</div>
	</div>
	<div class="formBar">
		<ul>
			<li>
				<div class="button">
					<div class="buttonContent">
						<button type="button" class="close" onclick="reloadSupplierList()">关闭</button>
					</div>
				</div></li>
		</ul>
	</div>
</div>
