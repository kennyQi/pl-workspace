<#assign contextPath=springMacroRequestContext.getContextPath() />
<div class="pageContent">
      <form method="post" id ="editrule_form_r" action="${contextPath}/rule/edite" class="pageForm required-validate"  >
		<div class="pageFormContent" layoutH="58" >
			 <div class="unit">
				<label>规则编码:</label>
				<input type="text" name="code" size="64"   maxlength="30"  value="${ruleEntity.code}"  readonly="readonly" />
			</div>
			<div class="unit">
				<label>规则名称：</label>
				<input class="required" type="text" name="name" size="64" class="required"  maxlength="64"   value="${ruleEntity.name}" />
			</div>
				<#assign startDate="${ruleEntity.startDate}"?date("yyyy-MM-dd")> 
				<#assign endDate="${ruleEntity.endDate}"?date("yyyy-MM-dd")>
				
	        <div class="unit">
				<label>开始日期：</label>
 				<input type="text" name="startDate"  id = "rule_startDate"  value="${startDate}"  class="required date"  minDate="2000-01-15" maxDate="2016-12-15" readonly="true" />
				<a class="inputDateButton" href="javascript:;">选择</a>
			</div>
		   <div class="unit">
				<label>结束日期：</label>
			  <input type="text" name="endDate"  id = "rule_endDate"   value="${endDate}"  class="required date"  minDate="2000-01-15" maxDate="2016-12-15" readonly="true" />
				<a class="inputDateButton" href="javascript:;">选择</a>
			</div>
			<div class="unit">
				<label>规则模板：</label>
				 <select class="required combox"  id="rule_select"  onchange="getRuleParam();">
					<option value="">所有类型</option>
					<#list templateList.list as t>
					  <option value="${t.code?replace(".","_")}"  <#if t.code?replace(".","_") ==  ruleEntity.logicClass?replace(".","_")>selected="selected"</#if> >${t.name}</option>
					</#list>
				</select>
				<input type="hidden"   name ="logicClass"  value=""  id="rule_template_hidden"   / >
			</div>	
			<div class="unit"  >
				<label>模板参数：</label>
				<table id="rule_template"></table>
			    <label  id ="template_props"   hidden="hidden">${ruleEntity.props}</label>
			    <input hidden="hidden" name="props" id="template_param"  value="" />
			</div>
			 <div class="unit">
				<label>产生积分账户类型：</label>
			   <select class="required combox"   name="accountType">
					<option value="">所有类型</option>
					<#list ruleTypeList as rl>
					<option value="${rl.me.code}" <#if rl.me.code == ruleEntity.accountType>selected="selected"</#if>>${rl.me.name}</option>
					</#list>
				</select>
			</div>
	    </div>
		<div class="formBar">
			<ul>
				<li><div class="buttonActive"><div class="buttonContent"><button type="button"   onclick="putProps()">更新</button></div></div></li>
				<li><div class="button"><div class="buttonContent"><button type="button" class="close">取消</button></div></div></li>
			</ul>
		</div>
	</form>
</div>

<script type="text/javascript">
$(document).ready(function(){
   //获得模板remark
     $("#rule_template").html("");
     //动态获得模板参数
     getRuleParam();
 
});

function getRuleParam()
{
      $("#rule_template").html("");
     var code = $("#rule_select").val();
     var newcode = code.replaceAll("_",".");//".","_"
     $("#rule_template_hidden").val(newcode);
			$.ajax({
				type: "post",
				url: "${contextPath}/rule/getParm?code="+newcode,
				cache:false,
				dataType:"json",
				success: function(data){
			   jsonL = data.length;
			  for (var i = 0; i<data.length; i++)
			  {
			  	   var ht="<tr>"
			  	   
			  	   +"<td><input type=\"text\"  id = 'param_props"+i+"'   name="+data[i].name +"   class='number required' ></input></td>"
			  	   +"<td>"+data[i].remark+"</td>"
			  	   +"</tr>";
	               $("#rule_template").append(ht);
			  }
			  	   //模板参数
		      var props  = $("#template_props").html();
		      
		      if(props.length > 2)
		      {
		       props = props.substr(1,props.length-2);
		    var arr = new Array();
		    arr = props.split(",");
		    for (var i =0 ; i<arr.length; i++)
		    {
		       var av = arr[i].split(":");
		       var vaLen = av[0].length;
		       var vnLen = av[1].length;
		       var inputName = av[0].substr(1,vaLen-2);
		      $("input[name="+inputName+"]").attr("value", av[1].substr(1,vnLen-2));
		    }
		      }

		  }, error:function(e){  alert("请求发生错误"); }
	     });
}

//组合参数和检验时间
function putProps(){
   parms();
   
  var f = $("#editrule_form_r");
  var flag = true;
  
  //判断日期
   var sd = $("#rule_startDate").val();
   var ed = $("#rule_endDate").val();
   var arr = sd.split("-");
   var sdata = new Date(arr[0],arr[1],arr[2]);
   var startData = sdata.getTime();
   var earr = ed.split("-");
   var edata = new Date(earr[0],earr[1],earr[2]);
   var endData = edata.getTime();
   if(startData > endData )
  {
   alert("开始时间不能大于结束时间！");
   flag =  false;
  }
  
  //页面校验
  if (flag)
  {
     flag = validateCallback(f, dialogAjaxDone);
  }
 
 //验证通过
  if(flag)
 {
    f.submit();
 }
 
  }
//组合模板参数放入隐藏域当做字段保存数据库
 function parms()
 {
  var content = "{";
  for(var i =0; i< jsonL; i++)
  {
       var pvalue = $("#param_props"+i).val() - 0;
       var pname = $("#param_props"+i).attr("name");
       
       content += "\""+pname+"\":\""+pvalue+"\"";
       if(i!=jsonL-1)
           content+=",";
  }
  content+="}";
  $("#template_param").val(content);
 
 }
</script>